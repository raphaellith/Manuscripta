# Validation Rules for Common Data Models

As the project chooses composition over inheritance, the integrity of data models shall be explicitly managed to reject invalid states.

All rules in this document shall be enumerated for the convenience of referencing. Numbering shall not be changed after approval in a PR.


### Section 1 — General Principles

(1) Both applications must:

    (a) Avoid making state transitions that will result in an illegal state;
    (b) Validate model state transitions, either within the models or in a service layer; and
    (c) Validate incoming data entity objects, before they are persisted or processed. 

(2) All objects must have an ID generated by the client on which the object is first created, as defined in Section 3. This field is not considered a data field, and so will not be explicitly defined in Section 2.

(3) Unless otherwise specified, any undefined fields shall be ignored - a data object with excessive fields shall be considered valid, so long as all defined fields conform.

(4) The client which receives the data object should treat it as immutable.

(5) The API Contract shall cite objects in this document where appropriate, and the JSON objects shall conform to this document accordingly. The API Contract shall —

    (a) Reference the data object, and the Section in this document where it is defined.
    (b) Where required, define serialisation and deserialisation rules.

If validation rules in API Contract are in contradiction to this document, this document shall have precedence.

(6) Names of classes and fields in this document, and any document subjecting to this document, shall use PascalCase. Names for enum members and constants shall use SCREAMING_SNAKE_CASE. However, this document does not prevent the use of another case for internal implementation where justifiable.

(7) This document shall only contain entities that are shared between the clients, and define only data fields and constraints used by all clients. The developers of each client may specify additional rules in their team-specific documentations.

### Section 1A - Applicability

(1) Rules specified in this document shall always apply to —

    (a) Data transfer objects (DTOs), as specified in the API Contract. 

(2) If a client receives an invalid DTO through an API defined in the API Contract, it must not conduct any further business logic processing, as if it had never received the TCP message or HTTP request containing the invalid DTO.

(3) If the invalid DTO is received through a HTTP request body, the client shall return HTTP Status 400 (Bad Request) for that request.

(4) The developers of each client are advised to specify additional applicability of this document in their team-specific documentations. 

### Section 2A — Data Validation Rules For `MaterialEntity` Objects

(1) A `MaterialEntity` object must have the following data fields to be considered valid:

    (a) `MaterialType` (enum MaterialType). Possible values are:
        (i) READING - The material is a reading material without questions
        (ii) WORKSHEET - The material is a worksheet with a mix of question types
        (iii) POLL - The material is a poll with one multiple choice question, whose response distribution is intended to be revealed.
        (iv) [DELETED]
    (b) `Title` (String). Maximum Length = 500 Characters.
    (c) `Content` (String). Refer to Material Encoding Specification for encoding rules.
    (d) `Timestamp` (Long). The unix timestamp of the previous modification.

(2) In addition to the mandatory fields in (1), a `MaterialEntity` object may have the following fields:

    (a) `Metadata` (String)
    (b) `Vocabulary Terms` (JSONArray)

### Section 2B - Data Validation Rules for `QuestionEntity` Objects

(1) A `QuestionEntity` object must have the following data fields to be considered valid:

    (a) `MaterialId` (UUID).
    (b) `QuestionType` (enum QuestionType). Possible Values are:
        (i) `MULTIPLE_CHOICE`: A question with a list of possible options.
        (ii) [DELETED]
        (iii) `WRITTEN_ANSWER`: A question whose response will be expected to be typed or handwritten.
    (c) `QuestionText` (String).

(2) In addition to the mandatory fields in (1), a `QuestionEntity` object may have the following fields:

    (a) `Options` (List<String>): The list of the options available, for multiple choice questions.
    (b) `CorrectAnswer` (Generic / Optional): The expected correct answer.
    (c) `MaxScore` (int): The maximum number of marks available for this question.

(3) Data fields defined in this Section must also conform to all the following constraints for the object to be valid:

    (a) The `MaterialId` specified in (1)(a) must associate with a `MaterialEntity` (M) whose `MaterialType` is not `READING`.
    (b) When `QuestionType` specified in (1)(b) is `WRITTEN_ANSWER`, M's MaterialType must not be `POLL`.
    (c) When `QuestionType` specified in (1)(b) is `MULTIPLE_CHOICE`, its `Options`, as specified in (2)(a) must be non-empty.
    (d) When `QuestionType` specified in (1)(b) is `MULTIPLE_CHOICE`, its `CorrectAnswer`, as specified in (2)(b), must be a valid index in its `Options`.
    (e) [DELETED]
    (f) When `QuestionType` specified in (1)(b) is `WRITTEN_ANSWER`, its `CorrectAnswer`, as specified in (2)(b), must be a valid String.
    (g) When M's MaterialType is `POLL`, there must not already exist a previously created `QuestionEntity` object whose `MaterialId` also associates with M.

### Section 2C - Data Validation Rules for `ResponseEntity` Objects

(1) A `ResponseEntity` object must have the following data fields to be considered valid:

    (a) `QuestionId` (UUID): The question the response is related to.
    (b) `Answer` (Generic Typing): The answer the student provides.
    (c) `Timestamp`: Time stamp of response.
    (d) `DeviceId` (UUID): The device ID the response is from.

(2) In addition to the mandatory fields in (1), a `ResponseEntity` object may have the following fields:

    (a) `IsCorrect` (Boolean): The android device may assist in validating simple questions (such as Multiple Choice or simple blank filling).

(3) Data fields defined in this Section must also conform to all the following constraints for the object to be valid:

    (a) The `QuestionId` specified in 1(a) must associate with a `QuestionEntity` (Q).
    (b) If Q's `QuestionType` is `MULTIPLE_CHOICE`, the `Answer`, specified in 2(a), must be a valid index in Q's `Options`.
    (c) [DELETED]
    (d) If Q's `QuestionType` is `WRITTEN_ANSWER`, the `Answer` should be a valid String.
    (e) A `DeviceId`, as specified in (1)(d), must correspond to a valid device.
    (f) There must not already exist a previously created `ResponseEntity` object with an identical `QuestionId` and `DeviceId` combination.


### Section 2D - Data Validation Rules for `SessionEntity`

(1) A `SessionEntity` object must have the following data fields to be considered valid:

    (a) `MaterialId` (UUID): References the material the student should work on during the lesson.
    (b) `SessionStatus`(enum SessionStatus). Possible values are:
        (i) `RECEIVED`: Material has been received; student has not yet interacted.
        (ii) `ACTIVE`: Session is currently active/ongoing.
        (iii) `PAUSED`: Session has been paused.
        (iv) `COMPLETED`: Session completed normally.
        (v) `CANCELLED`: Session was cancelled before completion.
    (c) `DeviceId` (UUID): The device ID the session is related to.

(2) In addition to the mandatory fields in (1), a `SessionEntity` object may have the following fields:

    (a) `StartTime` (long): Start unix timestamp, set when student first interacts with material.
    (b) `EndTime` (long): End unix timestamp, for non-active sessions.

(3) Data fields defined in this Section must also conform to all the following constraints for the object to be valid:

    (a) A `SessionEntity` whose `SessionStatus` is `RECEIVED` must not have `StartTime` or `EndTime`.
    (b) A `SessionEntity` whose `SessionStatus` is `ACTIVE` must have `StartTime` but must not have `EndTime`.
    (c) A `SessionEntity` whose `SessionStatus` is `PAUSED`, `COMPLETED` or `CANCELLED` must have both `StartTime` and `EndTime`.
    (d) A `DeviceId`, as specified in (1)(c), must correspond to a valid device.

### Section 2E - Data Validation Rules for `DeviceStatusEntity`

(1) A `DeviceStatusEntity` object must have the following data fields to be considered valid:

    (a) `DeviceId` (uuid). References the device the status is linked to.
    (b) `Status` (enum DeviceStatus). Possible values are:
        (i) `ON_TASK`: Student is active in the app.
        (ii) `IDLE`: No activity for a threshold period.
        (iii) `LOCKED`: Device is remotely locked.
        (iv)  `DISCONNECTED`: (Server-side inferred status).
    (c) `BatteryLevel` (int). The battery level of the device.
    (d) `CurrentMaterialId` (uuid). The material the device is currently viewing.
    (e) `StudentView` (String). Describes the location which the student is viewing.
    (f) `Timestamp` (long). The time at which the device status is correct to.

(2) Data fields defined in this Section must also conform to all the following constraints for the object to be valid:

    (a) The `DeviceId` specified in (1)(a) must reference a valid Device, which is deemed paired as defined in Pairing Process Specification.
    (b) The `BatteryLevel` specified in (1)(c) must be between 0 and 100.
    (c) The `CurrentMaterialId` specified in (1)(d) must reference a valid material.


### Section 2F - Data Validation Rules for `FeedbackEntity`

(1) A `FeedbackEntity` object must have the following data fields to be considered valid:

    (a) `ResponseId` (UUID). The response targeted by this feedback.

    (b) At least one of the following.
        
        (i) `Text` (String): Textual feedback.

        (ii) `Marks` (int): Number of marks awarded.

    
(2) Data fields defined in this Section must also conform to all the following constraints for the object to be valid:

    (a) The `ResponseId` specified in 1(a) must associate with a `ResponseEntity` (R).

    (b) The `QuestionEntity` (Q) with which R is associated must not have a `CorrectAnswer` field.

    (c) If the `Marks` field is present, then Q must have a `MaxScore` field, and the `Marks` value must not exceed the value of `MaxScore` given by Q.



### Section 3 - ID Generation Policy

(1) IDs of all data objects must be UUIDs.

(2) IDs must be generated by the client which creates the entity, namely —

    (a) `MaterialEntity`, `QuestionEntity` and `FeedbackEntity` objects should be generated by the Windows client.
    (b) `ResponseEntity` objects should be generated by the Android client.

(3) The client which receives the ID should treat it as immutable.

(4) Device IDs should be generated by the Android client on successful pairing. 

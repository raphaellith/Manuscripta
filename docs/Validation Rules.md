# Validation Rules for Common Data Models

As the project chooses composition over inheritance, the integrity of data models shall be explicitly managed to reject invalid states.

All rules in this document shall be enumerated for the convenience of referencing. Numbering shall not be changed after approval in a PR.


### Section 1 — General Principles

(1) Both applications must:

    (a) Avoid making state transitions that will result in an illegal state;

    (b) Validate model state transitions, either within the models or in a service layer;

    (c) Validate incoming data entity objects, before they are persisted. 

(2) All objects must have an ID generated by the client on which the object is first created, as defined in Section 3. This field is not considered a data field, and so will not be explicitly defined in Section 2.

(3) Unless otherwise specified, any undefined fields shall be ignored - a data object with excessive fields shall be considered valid, so long as all defined fields conform.

(4) The client which receives the data object should treat it as immutable.

(5) The API contract shall cite objects in this document where appropriate, and the JSON objects shall conform to this document accordingly. The API Constract shall —

    (a) Reference the data object, and the Section in this document where it is defined.
    (b) Where required, define serialisation and deserialisation rules.

If validation rules in API Contract are in contradiction to this document, this document shall have precedence.

(6) Names of classes and fields in this document, and any document subjecting to this document, shall use PascalCase. 

### Section 2A — Data Validation Rules For `MaterialEntity` Objects

(1) A `MaterialEntity` object must have the following data fields to be considered valid:

    (a) `MaterialType` (enum MaterialType). Possible values are:
        (i) READING - The material is a reading material without questions
        (ii) WORKSHEET - The material is a worksheet with a mix of question types
        (iii) POLL - The material is a poll with a multiple choice question, whose response distribution is intended to be revealed.
        (iv) QUIZ - Multiple Choice Quizzes
    (b) `Title` (String). Maximum Length = 500 Characters.
    (c) `Content` (String).
    (d) `Timestamp` (Long). The unix timestamp of the previous modification.

(2) In addition to the mandatory fields in (1), a `MaterialEntity` object may have the following fields:

    (a) `Metadata` (String)
    (b) `Vocabulary Terms` (JSONArray)


### Section 2B - Data Validation Rules for `QuestionEntity` Objects

(1) A `QuestionEntity` object must have the following data fields to be considered valid:

    (a) `MaterialId` (UUID).
    (b) `QuestionType` (enum QuestionType). Possible Values are:
        (i) `MULTIPLE_CHOICE`: A question with a list of possible options.
        (ii) `TRUE_FALSE`: A question whose response will be expected to be either true or false.
        (iii) `WRITTEN_ANSWER`: A question whose response will be expected to be typed or handwritten.
    (c) `QuestionText` (String).

(2) In addition to the mandatory fields in (1), a `QuestionEntity` object may have the following fields:

    (a) `Options` (List<String>): The list of the options available, for multiple choice questions.
    (b) `CorrectAnswer` (Generic / Optional): The expected correct answer.

(3) Data fields defined in this Section must also conform to all the following constraints for the object to be valid:

    (a) The `MaterialId` specified in (1)(a) must associate with a `MaterialEntity` (M) whose `MaterialType` is not `READING`.
    (b) When `QuestionType` specified in (1)(b) is `WRITTEN_ANSWER`, M's MaterialType must not be `POLL` or `QUIZ`.
    (c) When `QuestionType` specified in (1)(b) is `MULTIPLE_CHOICE`, its `Options`, as specified in (2)(a) must be non-empty.
    (d) When `QuestionType` specified in (1)(b) is `MULTIPLE_CHOICE`, its `CorrectAnswer`, as specified in (2)(b), must be a valid index in its `Options`.
    (e) When `QuestionType` specified in (1)(b) is `TRUE_FALSE`, its `CorrectAnswer`, as specified in (2)(b), must be a valid boolean value.
    (f) When `QuestionType` specified in (1)(b) is `WRITTEN_ANSWER`, its `CorrectAnswer`, as specified in (2)(b), must be a valid String.

### Section 2C - Data Validation Rules for `ResponseEntity` Objects

(1) A `ResponseEntity` object must have the following data fields to be considered valid:

    (a) `QuestionId` (UUID): The question the response is related to.
    (b) `Answer` (Generic Typing): The answer the student provides.
    (c) `Timestamp`: Time stamp of response.
    (d) `DeviceId` (UUID): The device ID the response is from.

(2) In addition to the mandatory fields in (1), a `ResponseEntity` object may have the following fields:

    (a) `IsCorrect` (Boolean): The android device may assist in validating simple questions (such as Multiple Choice, True/False or simple blank filling). 

(3) Data fields defined in this Section must also conform to all the following constraints for the object to be valid:

    (a) The `QuestionId` specified in 1(a) must associate with a `QuestionMaterial` (Q).
    (b) If Q's `QuestionType` is `MULTIPLE_CHOICE`, the `Answer`, specified in 2(a), must be a valid index in Q's `Options`.
    (c) If Q's `QuestionType` is `TRUE_FALSE`, the `Answer`, specified in 2(a), must be a valid boolean value.
    (d) If Q's `QuestionType` is `WRITTEN_ANSWER`, the `Answer` should be a valid String.
    (e) A `DeviceId`, as specified in (1)(d), must correspond to a valid device.

### Section 2D - Data Validation Rules for `SessionEntity`

(1) A `SessionEntity` object must have the following data fields to be considered valid:

    (a) `MaterialId` (UUID): References the material the student should work on during the lesson.
    (b) `SessionStatus`(enum SessionStatus). Possible values are:
        (i) `RECEIVED`: Material has been received; student has not yet interacted.
        (ii) `ACTIVE`: Session is currently active/ongoing.
        (iii) `PAUSED`: Session has been paused.
        (iv) `COMPLETED`: Session completed normally.
        (v) `CANCELLED`: Session was cancelled before completion.
    (c) `DeviceId` (UUID): The device ID the session is related to.

(2) In addition to the mandatory fields in (1), a `SessionEntity` object may have the following fields:

    (a) `StartTime` (long): Start unix timestamp, set when student first interacts with material.
    (b) `EndTime` (long): End unix timestamp, for non-active sessions.

(3) Data fields defined in this Section must also conform to all the following constraints for the object to be valid:

    (a) A `SessionEntity` whose `SessionStatus` is `RECEIVED` must not have `StartTime` or `EndTime`.
    (b) A `SessionEntity` whose `SessionStatus` is `ACTIVE` must have `StartTime` but must not have `EndTime`.
    (c) A `SessionEntity` whose `SessionStatus` is `PAUSED`, `COMPLETED` or `CANCELLED` must have both `StartTime` and `EndTime`.
    (d) A `DeviceId`, as specified in (1)(c), must correspond to a valid device.

### Section 2E - Data Validation Rules for `DeviceStatusEntity`

(1) A `DeviceStatusEntity` object must have the following data fields to be considered valid:

    (a) `DeviceId` (uuid). References the device the status is linked to.
    (b) `Status` (enum DeviceStatus). Possible values are:
        (i) `ON_TASK`: Student is active in the app.
        (ii) `IDLE`: No activity for a threshold period.
        (iii) `HAND_RAISED`: Student explicitly requested help.
        (iv) `LOCKED`: Device is remotely locked.
        (v)  `DISCONNECTED`: (Server-side inferred status).
    (c) `BatteryLevel` (int). The battery level of the device.
    (d) `CurrentMaterialId` (uuid). The material the device is currently viewing.
    (e) `StudentView` (String). Describes the location which the student is viewing.
    (f) `Timestamp` (long). The time at which the device status is correct to.

(2) Data fields defined in this Section must also conform to all the following constraints for the object to be valid:

    (a) The `DeviceId` specified in (1)(a) must reference a valid Device, which is deemed paired as defined in Pairing Process Specification.
    (b) The `BatteryLevel` specified in (1)(c) must be between 0 and 100.
    (c) The `CurrentMaterialId` specified in (1)(d) must reference a valid material.

### Section 3 - ID Generation Policy

(1) IDs of all data objects must be UUIDs.

(2) IDs must be generated by the client which creates the entity, namely —

    (a) `MaterialEntity`, `QuestionEntity` objects should be generated by the Windows client.
    (b) `ResponseEntity` objects should be generated by the Android client.

(3) The client which receives the ID should treat it as immutable.

(4) Device IDs should be generated by the Android client on successful pairing. 
